//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
//  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â• â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
//  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
//  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â•    â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘
//  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
//   â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•     â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•    â•šâ•â•   â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•
//////////////////////////////////////////////////////////////////////////////////////////////////////////////

const fs = require('fs');
const path = require('path');
const { cmd } = require('../command');
const moment = require('moment-timezone');

cmd({
  pattern: "allmenu",
  alias: ["commandlist", "help"],
  desc: "Fetch and display all available bot commands",
  category: "system",
  filename: __filename,
}, async (Void, m, text, { prefix }) => {
  try {
    const commandDir = path.join(__dirname, '../plugins');
    const commandFiles = fs.readdirSync(commandDir).filter(file => file.endsWith('.js'));

    let totalCommands = 0;
    const categories = {};
    const commandDetails = {};

    // Read all command files and extract patterns
    for (const file of commandFiles) {
      try {
        const filePath = path.join(commandDir, file);
        const content = fs.readFileSync(filePath, 'utf-8');
        
        // Extract pattern using regex
        const patternMatch = content.match(/pattern:\s*["'`](.*?)["'`]/);
        if (patternMatch) {
          const pattern = patternMatch[1];
          
          // Extract category
          const categoryMatch = content.match(/category:\s*["'`](.*?)["'`]/);
          const category = categoryMatch ? categoryMatch[1] : 'general';
          
          // Extract description
          const descMatch = content.match(/desc:\s*["'`](.*?)["'`]/);
          const description = descMatch ? descMatch[1] : 'No description available';
          
          // Extract alias
          const aliasMatch = content.match(/alias:\s*\[(.*?)\]/);
          let aliases = [];
          if (aliasMatch) {
            aliases = aliasMatch[1].split(',').map(a => a.trim().replace(/["'`]/g, ''));
          }
          
          if (!categories[category]) {
            categories[category] = [];
          }
          
          categories[category].push(pattern);
          commandDetails[pattern] = {
            description,
            aliases,
            category
          };
          totalCommands++;
        }
      } catch (fileErr) {
        console.error(`Error reading file ${file}:`, fileErr);
      }
    }

    // Function to stylize text
    const toUpperStylized = (text) => {
      return text.toUpperCase();
    };

    // Emoji mapping for categories
    const emojiByCategory = {
      'system': 'âš™ï¸',
      'general': 'ğŸ’«',
      'download': 'ğŸ“¥',
      'media': 'ğŸ¬',
      'fun': 'ğŸ®',
      'tools': 'ğŸ› ï¸',
      'owner': 'ğŸ‘‘',
      'search': 'ğŸ”',
      'group': 'ğŸ‘¥',
      'ai': 'ğŸ¤–'
    };

    let menu = `â•­â”â”â”ã€Š *ğ‚ğ€ğ’ğ„ğ˜ğ‘ğ‡ğğƒğ„ğ’ ğ—ğŒğƒ* ã€‹â”â”â”â”ˆâŠ·\n`;
    menu += `â”ƒââ•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
    menu += `â”ƒââ”‚â–¸  Usá´‡Ê€ : ${m.pushName || 'User'} ğŸŒŸ\n`;
    menu += `â”ƒââ”‚â–¸  Ê™á´€ÉªÊŸá´‡Ês : ğŒğ®ğ¥ğ­ğ¢ ğğğ¯ğ¢ğœğ\n`;
    menu += `â”ƒââ”‚â–¸  á´›á´á´›á´€ÊŸ á´„á´á´á´á´€É´á´…s : *${totalCommands}*\n`;
    menu += `â”ƒââ â”‚â–¸  ğ–³Êá´˜á´‡ : ğğ¨ğğğ£ğ¬\n`;
    menu += `â”ƒââ”‚â–¸  á´˜ÊŸá´€á´›Ò“á´Ê€á´ : ğ‡ğğ«ğ¨ğ¤ğ®\n`;
    menu += `â”ƒââ â”‚â–¸  ğ–µá´‡Ê€sÉªá´É´ : ğŸ.ğŸ.ğŸ\n`;
    menu += `â”ƒââ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
    menu += `â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”ˆâŠ·\n\n`;

    // Add sorted categories with stylized text
    const sortedCategories = Object.keys(categories).sort();
    
    for (const cat of sortedCategories) {
      const emoji = emojiByCategory[cat] || 'ğŸ’«';
      menu += `â•­â”€ã€ ${emoji} ${toUpperStylized(cat)} ${toUpperStylized('Menu')} ã€â”€â”€âŠ·\n`;
      
      for (const cmd of categories[cat].sort()) {
        const details = commandDetails[cmd];
        const aliasText = details.aliases.length > 0 ? ` (${details.aliases.join(', ')})` : '';
        menu += `â”‚ â€¢ ${prefix}${cmd}${aliasText}\n`;
        menu += `â”‚   â””â”€ ${details.description}\n`;
      }
      menu += `â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âŠ·\n\n`;
    }

    const time = moment().tz('Africa/Nairobi').format('HH:mm:ss');
    const date = moment().tz('Africa/Nairobi').format('dddd, MMMM Do YYYY');

    const caption = menu;

    const messageOptions = {
      image: { url: "https://files.catbox.moe/y3j3kl.jpg" },
      caption: caption,
      contextInfo: {
        forwardingScore: 1,
        isForwarded: true,
        forwardedNewsletterMessageInfo: {
          newsletterJid: '120363420261263259@newsletter',
          newsletterName: 'á´„á´€sá´‡ÊÊ€Êœá´á´…á´‡s á´ÉªÉ´Éª Ê™á´á´›ğŸŒŸ',
          serverMessageId: -1
        },
        externalAdReply: {
          title: "CASEYRHODES TECH",
          body: `á´˜á´á´¡á´‡Ê€á´‡á´… Ê™Ê á´„á´€sá´‡ÊÊ€Êœá´á´…á´‡s á´›á´‡á´„Êœ | ${time}`,
          mediaType: 1,
          thumbnailUrl: "https://files.catbox.moe/y3j3kl.jpg",
          sourceUrl: "https://github.com/CASEYRHODES-TECH/CASEYRHODES-XMD"
        }
      }
    };

    await Void.sendMessage(m.chat, messageOptions, { quoted: m });
  } catch (err) {
    console.error(err);
    await m.reply('âŒ Error: Could not fetch the command list.');
  }
});
